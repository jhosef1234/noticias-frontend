// Setup type definitions for built-in Supabase Runtime APIs
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from 'jsr:@supabase/supabase-js@2';

// Headers CORS para permitir solicitudes desde cualquier origen
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
};

Deno.serve(async (req: Request) => {
  // Manejar solicitudes OPTIONS (preflight)
  if (req.method === 'OPTIONS') {
    return new Response(null, {
      headers: corsHeaders,
      status: 200,
    });
  }

  try {
    // Inicializar Supabase
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    const url = new URL(req.url);
    const action = url.searchParams.get('action');
    const requestId = url.searchParams.get('id');
    const confirmStatus = url.searchParams.get('status');
    const apikeyFromUrl = url.searchParams.get('apikey');
    
    // Para solicitudes GET de confirmaci√≥n, verificar que tenga el apikey en la URL
    // Esto permite acceso sin header de autorizaci√≥n
    if (req.method === 'GET' && action === 'confirm') {
      const expectedAnonKey = Deno.env.get('SUPABASE_ANON_KEY');
      if (!expectedAnonKey || apikeyFromUrl !== expectedAnonKey) {
        return new Response(
          JSON.stringify({ error: 'Unauthorized: Invalid or missing API key' }),
          {
            headers: { 
              ...corsHeaders,
              'Content-Type': 'application/json' 
            },
            status: 401,
          }
        );
      }
    }

    // Si es una confirmaci√≥n desde el email
    if (action === 'confirm' && requestId && confirmStatus) {
      console.log(`üìß Confirmaci√≥n recibida: ${confirmStatus} para solicitud ${requestId}`);

      // Construir el objeto de actualizaci√≥n seg√∫n el estado
      let updateData: { status: string; approved_at?: string; revoked_at?: string };
      
      if (confirmStatus === 'approved') {
        updateData = {
          status: confirmStatus,
          approved_at: new Date().toISOString()
        };
        
        // Obtener el email del usuario
        const { data: request, error: fetchError } = await supabase
          .from('payment_requests')
          .select('user_email')
          .eq('id', parseInt(requestId))
          .single();

        if (request && !fetchError) {
          console.log(`‚úÖ Usuario ${request.user_email} ser√° agregado a pro_users`);
        }
      } else if (confirmStatus === 'rejected') {
        updateData = {
          status: confirmStatus,
          revoked_at: new Date().toISOString()
        };
      } else {
        updateData = {
          status: confirmStatus
        };
      }

      const { error: updateError } = await supabase
        .from('payment_requests')
        .update(updateData)
        .eq('id', parseInt(requestId));

      if (updateError) {
        console.error('‚ùå Error actualizando solicitud:', updateError);
        throw updateError;
      }

      console.log(`‚úÖ Solicitud ${requestId} actualizada a ${confirmStatus}`);

      // Redirigir a la p√°gina de confirmaci√≥n
      const siteUrl = Deno.env.get('SITE_URL') || 'http://localhost:4200';
      return new Response(null, {
        status: 302,
        headers: {
          ...corsHeaders,
          'Location': `${siteUrl}/payment-confirmed?status=${confirmStatus}`
        }
      });
    }

    // Si es enviar email (llamado desde el frontend)
    if (req.method === 'POST' && action === 'send') {
      const body = await req.json();
      console.log('üì§ Datos recibidos:', JSON.stringify(body, null, 2));
      
      // El body puede venir como { payment_request: {...} } o directamente como el objeto
      const paymentRequest = body.payment_request || body;
      
      console.log('üì§ Enviando email para solicitud:', paymentRequest.id);

      // SIEMPRE usar este email del admin (hardcodeado para garantizar que llegue)
      const adminEmail = 'jhosefqh123@gmail.com';
      console.log('üìß Email del admin configurado:', adminEmail);
      
      const siteUrl = Deno.env.get('SITE_URL') || 'http://localhost:4200';
      const supabaseFunctionsUrl = supabaseUrl.replace('/rest/v1', '');
      
      // Crear links de confirmaci√≥n que apuntan a nuestra aplicaci√≥n
      // La app luego llamar√° a la Edge Function con los headers correctos
      const approveUrl = `${siteUrl}/payment-confirmed?id=${paymentRequest.id}&status=approved`;
      const rejectUrl = `${siteUrl}/payment-confirmed?id=${paymentRequest.id}&status=rejected`;

      console.log('üìß URLs de confirmaci√≥n:');
      console.log('  - Aprobar:', approveUrl);
      console.log('  - Rechazar:', rejectUrl);

      // Enviar email usando Resend
      const resendApiKey = Deno.env.get('RESEND_API_KEY');
      
      if (!resendApiKey) {
        console.error('‚ùå RESEND_API_KEY no configurada');
        return new Response(
          JSON.stringify({ success: false, error: 'RESEND_API_KEY no configurada' }),
          {
            headers: { 
              ...corsHeaders,
              'Content-Type': 'application/json' 
            },
            status: 500,
          }
        );
      }

      console.log('üìß Enviando email a trav√©s de Resend...');
      console.log('üìß Destinatario:', adminEmail);
      console.log('üìß Asunto: Nueva solicitud de pago - Plan Pro');

      const emailPayload = {
        from: 'Portal de Noticias <onboarding@resend.dev>',
        to: adminEmail,
        subject: 'Nueva solicitud de pago - Plan Pro',
          html: `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; }
                .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; }
                .info-box { background: white; padding: 15px; margin: 15px 0; border-left: 4px solid #9333ea; border-radius: 5px; }
                .button { display: inline-block; padding: 12px 24px; margin: 10px 5px; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
                .button-approve { background: #10b981; }
                .button-reject { background: #ef4444; }
                .footer { background: #f3f4f6; padding: 15px; text-align: center; font-size: 12px; color: #6b7280; border-radius: 0 0 10px 10px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>üìß Nueva Solicitud de Pago - Plan Pro</h2>
                </div>
                <div class="content">
                  <h3>Detalles del Cliente:</h3>
                  <div class="info-box">
                    <p><strong>Nombre:</strong> ${paymentRequest.user_name}</p>
                    <p><strong>Email:</strong> ${paymentRequest.user_email}</p>
                    <p><strong>Tel√©fono:</strong> ${paymentRequest.user_phone}</p>
                    <p><strong>Fecha del pago:</strong> ${paymentRequest.payment_date} ${paymentRequest.payment_time}</p>
                    <p><strong>ID de solicitud:</strong> #${paymentRequest.id}</p>
                  </div>
                  <div style="text-align: center; margin: 30px 0;">
                    <a href="${approveUrl}" class="button button-approve">‚úÖ Aprobar</a>
                    <a href="${rejectUrl}" class="button button-reject">‚ùå Rechazar</a>
                  </div>
                  <p style="margin-top: 20px; font-size: 12px; color: #6b7280;">
                    O puedes gestionar esta solicitud desde el <a href="${siteUrl}/admin">Panel de Administraci√≥n</a>
                  </p>
                </div>
                <div class="footer">
                  <p>Portal de Noticias - Sistema de Administraci√≥n</p>
                </div>
              </div>
            </body>
            </html>
          `,
      };

      console.log('üìß Payload del email:', JSON.stringify({
        from: emailPayload.from,
        to: emailPayload.to,
        subject: emailPayload.subject,
        html_length: emailPayload.html.length
      }, null, 2));

      const emailResponse = await fetch('https://api.resend.com/emails', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${resendApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(emailPayload),
      });

      console.log('üìß Respuesta de Resend - Status:', emailResponse.status);
      console.log('üìß Respuesta de Resend - Status Text:', emailResponse.statusText);

      if (!emailResponse.ok) {
        const errorData = await emailResponse.text();
        console.error('‚ùå Error enviando email a Resend:');
        console.error('  Status:', emailResponse.status);
        console.error('  Error:', errorData);
        
        // Intentar parsear el error como JSON
        try {
          const errorJson = JSON.parse(errorData);
          console.error('  Error JSON:', JSON.stringify(errorJson, null, 2));
        } catch (e) {
          console.error('  Error (texto):', errorData);
        }
        
        return new Response(
          JSON.stringify({ 
            success: false, 
            error: `Error enviando email: ${errorData}`,
            status: emailResponse.status 
          }),
          {
            headers: { 
              ...corsHeaders,
              'Content-Type': 'application/json' 
            },
            status: emailResponse.status,
          }
        );
      }

      const emailResult = await emailResponse.json();
      console.log('‚úÖ Email enviado exitosamente a Resend:');
      console.log('  Email ID:', emailResult.id);
      console.log('  Resultado completo:', JSON.stringify(emailResult, null, 2));

      return new Response(
        JSON.stringify({ success: true, message: 'Email enviado correctamente', emailId: emailResult.id }),
        {
          headers: { 
            ...corsHeaders,
            'Content-Type': 'application/json' 
          },
          status: 200,
        }
      );
    }

    return new Response(
      JSON.stringify({ error: 'Acci√≥n no v√°lida' }),
      {
        headers: { 
          ...corsHeaders,
          'Content-Type': 'application/json' 
        },
        status: 400,
      }
    );

  } catch (error: any) {
    console.error('‚ùå Error en Edge Function:', error);
    return new Response(
      JSON.stringify({ error: error.message || 'Error desconocido' }),
      {
        headers: { 
          ...corsHeaders,
          'Content-Type': 'application/json' 
        },
        status: 500,
      }
    );
  }
});

